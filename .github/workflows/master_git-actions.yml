name: Build and deploy ASP.Net Core app to On-Premises Server - Git Actions

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted

    steps:
    - name: Stop IIS app pool
      run: |
        $appPoolName = 'git-actions-poc'
        Import-Module WebAdministration -Verbose
        Write-Output "Stopping IIS app pool $appPoolName"
        Stop-WebAppPool -Name $appPoolName
      shell: pwsh

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: '8.x'   

    - name: Restore dependencies
      run: dotnet restore

    - name: Build with dotnet
      run: dotnet build --configuration Release

    - name: Publish with dotnet
      run: dotnet publish -c Release -o ${{ github.workspace }}/publish

    - name: Upload artifact for deployment
      uses: actions/upload-artifact@v2
      with:
        name: published-app
        path: ${{ github.workspace }}/publish

  deploy:
    runs-on: self-hosted

    steps:
    - name: Download artifact from build
      uses: actions/download-artifact@v2
      with:
        name: published-app
        path: ${{ github.workspace }}/publish

    - name: Deploy to IIS
      run: |
        $sourcePath = "${{ github.workspace }}/publish"
        $destinationPath = "D:\apps\git-actions-poc" # Update with your app folder
        Write-Output "Copying files from $sourcePath to $destinationPath"
        Copy-Item -Path $sourcePath\* -Destination $destinationPath -Recurse -Force
      shell: pwsh

    - name: Start IIS app pool
      run: |
        $appPoolName = 'git-actions-poc'
        Import-Module WebAdministration -Verbose
        Write-Output "Starting IIS app pool $appPoolName"
        Start-WebAppPool -Name $appPoolName
      shell: pwsh
